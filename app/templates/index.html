<!-- app/templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —Å–∫–æ—Ä–∏–Ω–≥–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –±–∞–Ω–∫—Ä–æ—Ç–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        .status-indicator {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-idle { background-color: #6c757d; }
        .status-running { background-color: #ffc107; animation: pulse 1s infinite; }
        .status-completed { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        
        .file-card {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">–°–∏—Å—Ç–µ–º–∞ —Å–∫–æ—Ä–∏–Ω–≥–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –±–∞–Ω–∫—Ä–æ—Ç–æ–≤</h1>
        
        <!-- –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="status-indicator status-{{ status }}"></div>
                    <div>
                        <strong id="stage">{{ stage }}</strong>
                        <div id="message">{{ message }}</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" 
                             style="width: {{ progress }}%;" 
                             aria-valuenow="{{ progress }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">{{ progress }}%</div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                    <button id="start-btn" class="btn btn-primary" 
                            {{ 'disabled' if status == 'running' else '' }}>
                        <i class="bi bi-play-circle"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–æ—Ä–∏–Ω–≥
                    </button>
                    
                    <button id="download-btn" class="btn btn-success" 
                            {{ 'disabled' if not (status == 'completed' and result) else '' }}>
                        <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –ë–ª–æ–∫ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>üìç –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</h5>
            </div>
            <div class="card-body">
                <form id="scoringForm">
                    <!-- –ì–µ–æ–≥—Ä–∞—Ñ–∏—è -->
                    <div class="mb-3">
                        <label class="form-label">–ì–µ–æ–≥—Ä–∞—Ñ–∏—è (—Ä–µ–≥–∏–æ–Ω):</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="77" id="region_moscow" name="regions">
                            <label class="form-check-label" for="region_moscow">–ú–æ—Å–∫–≤–∞</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="16" id="region_tatarstan" name="regions">
                            <label class="form-check-label" for="region_tatarstan">–¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="64" id="region_saratov" name="regions">
                            <label class="form-check-label" for="region_saratov">–°–∞—Ä–∞—Ç–æ–≤</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="40" id="region_kaluga" name="regions">
                            <label class="form-check-label" for="region_kaluga">–ö–∞–ª—É–≥–∞</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="select_all_regions">
                            <label class="form-check-label" for="select_all_regions">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</label>
                        </div>
                    </div>
                    
                    <!-- –°—É–º–º–∞ –¥–æ–ª–≥–∞ -->
                    <div class="mb-3">
                        <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–æ–ª–≥–∞ (—Ä—É–±.):</label>
                        <input type="number" class="form-control" name="min_debt_amount" value="250000">
                    </div>
                    
                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
                    <div class="mb-3">
                        <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exclude_bankrupts" id="exclude_bankrupts" checked>
                            <label class="form-check-label" for="exclude_bankrupts">–ò—Å–∫–ª—é—á–∞—Ç—å –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã—Ö –±–∞–Ω–∫—Ä–æ—Ç–æ–≤</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exclude_no_debt" id="exclude_no_debt" checked>
                            <label class="form-check-label" for="exclude_no_debt">–ò—Å–∫–ª—é—á–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –±–µ–∑ –¥–æ–ª–≥–æ–≤</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="only_with_property" id="only_with_property">
                            <label class="form-check-label" for="only_with_property">–¢–æ–ª—å–∫–æ —Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="only_bank_mfo_debt" id="only_bank_mfo_debt">
                            <label class="form-check-label" for="only_bank_mfo_debt">–¢–æ–ª—å–∫–æ —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∏–ª–∏ –ú–§–û-–¥–æ–ª–≥–∞–º–∏</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="only_recent_court_orders" id="only_recent_court_orders">
                            <label class="form-check-label" for="only_recent_court_orders">–¢–æ–ª—å–∫–æ —Å —Å—É–¥–µ–±–Ω—ã–º–∏ –ø—Ä–∏–∫–∞–∑–∞–º–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="only_active_inn" id="only_active_inn" checked>
                            <label class="form-check-label" for="only_active_inn">–¢–æ–ª—å–∫–æ —Å –∂–∏–≤—ã–º–∏ –ò–ù–ù</label>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- –ë–ª–æ–∫ 2: –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>üìÅ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h5>
            </div>
            <div class="card-body">
                <div id="files-container">
                    {% for file in files %}
                    <div class="card file-card">
                        <div class="card-body">
                            <h6 class="card-title">{{ file.filename }}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    –ò—Å—Ç–æ—á–Ω–∏–∫: {{ file.source }} | 
                                    –†–∞–∑–º–µ—Ä: {{ file.size_mb|round(2) }} MB | 
                                    –ò–∑–º–µ–Ω–µ–Ω: {{ file.last_modified }}
                                </small>
                            </p>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- –ë–ª–æ–∫ 3: –õ–æ–≥–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üìù –ñ—É—Ä–Ω–∞–ª –æ—à–∏–±–æ–∫</h5>
                <button id="refresh-logs" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-repeat"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            <div class="card-body">
                <div class="log-container" id="logs-container">
                    <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            function updateStatus() {
                $.get("/status", function(data) {
                    $("#progress-bar")
                        .css("width", data.progress + "%")
                        .attr("aria-valuenow", data.progress)
                        .text(data.progress + "%");
                    
                    $("#stage").text(data.stage);
                    $("#message").text(data.message);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Å—Ç–∞—Ç—É—Å–∞
                    $(".status-indicator")
                        .removeClass("status-idle status-running status-completed status-error")
                        .addClass("status-" + data.status);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                    $("#start-btn").prop("disabled", data.status === "running");
                    $("#download-btn").prop("disabled", !(data.status === "completed" && data.result));
                });
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
            function loadLogs() {
                $.get("/logs?limit=10", function(logs) {
                    const container = $("#logs-container");
                    container.empty();
                    
                    if (logs.length === 0) {
                        container.append('<div class="text-center text-muted">–ù–µ—Ç –æ—à–∏–±–æ–∫</div>');
                        return;
                    }
                    
                    logs.forEach(log => {
                        const logElement = `
                            <div class="log-entry mb-2">
                                <div class="d-flex justify-content-between">
                                    <strong>${log.source}</strong>
                                    <small>${new Date(log.timestamp).toLocaleString()}</small>
                                </div>
                                <div><small>${log.error_type}: ${log.error_message}</small></div>
                                ${log.lead_id ? `<div><small>Lead ID: ${log.lead_id}</small></div>` : ''}
                            </div>
                            <hr>
                        `;
                        container.append(logElement);
                    });
                });
            }
            
            // –ó–∞–ø—É—Å–∫ —Å–∫–æ—Ä–∏–Ω–≥–∞
            $("#start-btn").click(function() {
                const formData = $("#scoringForm").serializeArray();
                const data = {};
                
                formData.forEach(item => {
                    if (item.name === "regions") {
                        if (!data[item.name]) data[item.name] = [];
                        data[item.name].push(item.value);
                    } else {
                        data[item.name] = item.value;
                    }
                });
                
                $.post("/start-scoring", data, function() {
                    updateStatus();
                });
            });
            
            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            $("#download-btn").click(function() {
                window.location.href = "/download";
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤
            $("#refresh-logs").click(loadLogs);
            
            // –í—ã–±–æ—Ä –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
            $("#select_all_regions").change(function() {
                const isChecked = $(this).prop("checked");
                $("input[name='regions']").prop("checked", isChecked);
            });
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            setInterval(updateStatus, 5000);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            updateStatus();
            loadLogs();
        });
    </script>
</body>
</html>